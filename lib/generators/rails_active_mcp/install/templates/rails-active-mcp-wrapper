#!/usr/bin/env bash

# Rails Active MCP Wrapper Script
# Re-execs through the user's login shell to pick up Ruby version manager
# configuration (rbenv, asdf, mise, rvm, chruby, etc.) that MCP hosts
# don't load automatically.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
USER_SHELL="${SHELL:-/bin/bash}"

# Save real stdout to fd 3, redirect stdout to stderr during shell init
# to prevent profile output from corrupting MCP protocol
exec 3>&1 1>&2

exec "$USER_SHELL" -l -c '
    exec 1>&3 3>&-   # restore real stdout for MCP server

    cd "$1" || { echo "Error: Cannot cd to $1" >&2; exit 1; }

    if [ ! -f "Gemfile" ]; then
        echo "Error: Gemfile not found" >&2; exit 1
    fi

    export RAILS_ENV="${RAILS_ENV:-development}"
    exec bundle exec rails-active-mcp-server "$@"
' _ "$PROJECT_ROOT" "$@"
